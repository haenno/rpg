<!DOCTYPE html>
{% load static %}
<html lang="de">
  <head>
    {% block html_head %} {% endblock %}
    <link href="/static/favicon.ico" rel="icon" type="image/x-icon" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RPG-Adventure</title>
  </head>
  <body style="background-color:#006E9C;">


    {% block content %} 



    <div id="game_websocket_content_rx" style="font-family: Arial, Helvetica, sans-serif;  font-size: 2vw;     color: #ffffff;">
  
    <table  cellpadding="0"     cellspacing="0"
    style="height: 100%;       width: 100%;
      position: absolute;       top: 0;       bottom: 0;
      left: 0;       right: 0;">

    <tr style="height: 40%; width: 100%">
      <td  style="  background-color: #3EB96A;
          vertical-align: middle;
          text-align: center;
          width:50%;  " >

          <video loop="true" autoplay="autoplay" autoplay muted style="max-width: auto; height: 20vw;">
            <source src="../static/animation/{{enemy_image}}"  type="video/mp4" />
            </video>
  
      </td>

      <td style="background-color: #00A97F;   vertical-align: middle;  text-align: center; width:50%; "  rowspan="3">
  
        
        <div id="game_log_textara" style="        margin: 0 auto;
        width:95%; 
        height:95%; 
        font-family: monospace;
        font-size: 0.7vw;
        text-align: left;
        border:0vw;
        overflow-y: scroll;">
  
  
      </div>
    </div>
      </td>
    </tr>

    <tr style="height: 40%; width: 100%">

      <td style=" background-color: #009690;        vertical-align: middle;        text-align: center; ">
      <div style="vertical-align: middle;       text-align: center;    margin: auto;">

      
        {% for user_char in game_user_char_list %} 
        <table style="width: 95%; border-collapse: collapse; margin: 0.5vw; display: inline-table; ">
        <tr style="border:0.2vw solid; ">

      <td style="border:0.1vw solid; width:20%"> 
        <div style="font-size: 4vw;">
          {% if user_char.klasse == "W" %} ðŸ¤º {% endif %}
          {% if user_char.klasse == "M" %} ðŸ§™ {% endif %}
          {% if user_char.klasse == "P" %} ðŸ‘¼ {% endif %}          
              
        </div>
          </td>

      <td style="border:0.1vw solid;  width:60%">
        
        <div style=" font-family: Arial, Helvetica, sans-serif;         font-size: 1.4vw;         color: #ffffff;  ">
          {{user_char.name}}
        </div>
          <div style=" font-family: Arial, Helvetica, sans-serif;             font-size: 0.9vw;          color: #ffffff;  ">
          HP: {{user_char.hp}} /  AP: {{user_char.ap}} 
        </div>
      
      </td>

      <td style="border:0.1vw solid;  width:20%; ">
        <div style="font-family: Arial, Helvetica, sans-serif;
        font-size: 1vw;
        color: #ffffff;">  

        {% if user_char.user_char_id == request_user_id  %} 
        <input type="submit" value="Angriff" onclick="game_action('attack', {{ user_char.user_char_in_games_id }});" style="width:80%; color: #000000; background:#ffffff; border:0vw; font-size: 1.1vw; margin:0.3vw;"> <br />
        <input type="submit" value="FÃ¤higkeit" onclick="game_action('ability', {{ user_char.user_char_in_games_id }});"  style="width:80%;  color: #000000; background:#ffffff; border:0vw;  font-size: 1.1vw; margin:0.3vw;"> <br />
        <input type="submit" value="Aussetzen" onclick="game_action('pass', {{ user_char.user_char_in_games_id }});"  style="width:80%;  color: #000000;  background:#ffffff; border:0vw;  font-size: 1.1vw; margin:0.3vw;"> <br />
        {% else %}

        <div id="user_char_is_ready_{{ user_char.user_char_in_games_id }}"></div>

        {% endif %}
      </div>
      </td>

        </tr> 
      </table><br />
      <br />
        {% endfor %}
     
    </div>


      
      </td>

      
    </tr>

  
    <tr style="height: 20%; width: 100%">

      <td style="background-color: #00839B;        vertical-align: middle;          text-align: center;">
  
        <input type="text" id="game_chat_msg_text" name="game_chat_msg_text" onkeypress="return game_chat_msg_key(event, {{ request_user_id }})"  style="width: 50%; border:0.1vw solid;  color: #000000;  background:#ffffff; font-size: 1.1vw; margin:0.3vw;"> 
        <input type="submit" value="Nachricht senden" onclick="game_chat_msg_click({{ request_user_id }});" style="background:#ffffff;   color: #000000; border:0vw; font-size: 1.1vw; margin:0.3vw;"> 

        <br /><input type="submit" value="Dev/Debug: Spiel beenden" onclick="set_game_to_finished();" style="background:#ff0000;"" >
  
      </td>

    </tr>

  </table>
  

  </div>


    {{ game_id|json_script:"game_id" }}
    {{ request_user_id|json_script:"request_user_id" }}
     
    <script>
      last_counter_value_update = new Date();
      var last_game_log_content = "";
      var log_textara = document.querySelector('#game_log_textara');

      var game_ws_loc = window.location;
      var game_ws_prot = "ws://";
      if (game_ws_loc.protocol == "https:") {
          game_ws_prot = "wss://";
      }
      
      const game_id = JSON.parse(
          document.getElementById("game_id").textContent
      );
      const request_user_id = JSON.parse(
          document.getElementById("request_user_id").textContent
      );      

      const game_socket = new WebSocket(
          game_ws_prot + window.location.host + "/ws/game-" + game_id + "/"
      );
      
      
      function set_game_to_finished() {
          game_socket.send(JSON.stringify({
              msg: 'set_game_to_finished',
              game_id: game_id,
          }));
      }
     
      function game_chat_msg_click(user_id) {
        var msg_to_gamelog_text = document.querySelector("#game_chat_msg_text").value
        game_socket.send(JSON.stringify({
            msg: 'game_chat_msg',
            msg_to_gamelog: msg_to_gamelog_text,
            user_id: user_id,
        }));
        document.querySelector("#game_chat_msg_text").value = '';
    }     

    function game_chat_msg_key(eventKeyPress, user_id) {
      if (eventKeyPress.keyCode == 13) {
        game_chat_msg_click(user_id)
      }
  }    

    function game_action(action_type, user_char_in_games_id) {
      game_socket.send(JSON.stringify({
          msg: 'save_game_action',
          game_id: game_id,
          action_type: action_type,
          user_char_in_games_id, user_char_in_games_id,
      }));
  }

    
    
      game_socket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          console.log(data)
      
          if (data.game_msg_type == 'game_content_update') {
              document.querySelector("#game_websocket_content_rx").innerHTML =
                  data.game_websocket_content;
          }
      
          if (data.game_msg_type == 'game_log_update') {
            if (last_game_log_content != data.game_websocket_content) {
              document.querySelector("#game_log_textara").innerHTML =
                  data.game_websocket_content;
                  last_game_log_content = data.game_websocket_content;
                  log_textara.scrollTop = log_textara.scrollHeight;
                }
          }
      
          if (data.game_msg_type == 'game_counter_update') {
            // only useage of this is, to see if the connection is still alive  
            last_counter_value_update = new Date();
          }
      
          if (data.game_msg_type == 'game_endscreen') {
              document.querySelector("#game_websocket_content_rx").innerHTML =
                  data.game_websocket_content;
          }
      
          if (data.game_msg_type == 'game_init_content') {
              document.querySelector("#game_websocket_content_rx").innerHTML =
                  data.game_websocket_content;
          }
      };
      
      
      
      // Game-log
      
      var game_timer_helper = 0;
      
      function local_game_loop() {
          console.log(JSON.stringify(game_timer_helper))

          // on 0 
          if (game_timer_helper == 0) {
              game_socket.send(JSON.stringify({
                  msg: "alive",
                  request_user_id: request_user_id,                               
                }));
          }
      
          // on 1 
          if (game_timer_helper == 1) {


        }           

          // on 2 
          if (game_timer_helper == 2) {
            game_socket.send(JSON.stringify({
                msg: "alive",
                request_user_id: request_user_id,                 
              }));
        }
          // on 3
          if (game_timer_helper == 3) {


        }          
        // allways

    
            // check if connection is still alive
            timediff = new Date() - last_counter_value_update;
            if (timediff > 6000) {
              console.log("We lost connection since (sec): " + timediff/1000);  
              window.alert("Die Verbindung zum Server wurde getrennt. \nBitte lade die Seite neu. \nDas Spiel sollte dann weitergehen.");
              clearInterval(gameLoopInterval);
            }      

          // count to 4 and reset to 0 if it is reached, so that there are 4 "stages" (0..3)
          game_timer_helper = game_timer_helper + 1;
          if (game_timer_helper == 4) 
          {
            game_timer_helper = 0;
          }
      
      
      }
      
      var gameLoopInterval = setInterval(local_game_loop, 500);


    </script>
    <!-- End Game Websocket -->

    {% endblock %}
  </body>
</html>
